<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" type="text/css" href="css/idView.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
	<title>IDView</title>
	<style>
		body{
			margin: 0;
		}
		.chargeSessions{
			list-style-type: none;
			padding: 0;
		}
		.chargeSession{
			padding-top: 1.5vw;
			padding-bottom: 1.5vw;
			margin-top: 1vw;
			background: #111;
			border-radius: 0.5em;
			display: flex;
			justify-content: space-between;
		}
		.chargeSessionDougnut{
			width: 15%;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		.chargeSessionElement{
			border-left: solid thin white;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			flex-grow: 1;
			flex-basis: 0;
		}
		.chargeSessionValue{
			font-size: 2.5vw;
		}
		.chargeSessionValue.big{
			font-size: 4.5vw;
		}
		.chargeSessionValue.small{
			font-size: 2vw;
		}
	</style>
</head>
<body>
	<ul class="chargeSessions" id="chargeSessions">
		<li class="chargeSession">
			<div class="chargeSessionDougnut">
				<span class="chargeSessionValue small">SOC</span>
			</div>
			<div class="chargeSessionElement">
				<span class="chargeSessionValue small">charged kWh</span>
			</div>
			<div class="chargeSessionElement">
				<span class="chargeSessionValue small">gained range</span>
			</div>
			<div class="chargeSessionElement">
				<span class="chargeSessionValue small">power (âŒ€, min, max)</span>
			</div>
			<div class="chargeSessionElement">
				<span class="chargeSessionValue small">duration and date</span>
			</div>
		</li>
		<template id="chargeSession">
			<li class="chargeSession">
				<div class="chargeSessionDougnut">
					<canvas id="chargesoc"></canvas>
				</div>
				<div class="chargeSessionElement">
					<span class="chargeSessionValue big" id="kWh">00.00kWh</span>
				</div>
				<div class="chargeSessionElement">
					<span class="chargeSessionValue big" id="range">000km</span>
				</div>
				<div class="chargeSessionElement">
					<span class="chargeSessionValue big" id="avgchargepower">XXXkW</span>
					<span class="chargeSessionValue" id="minMaxChargePower">min XXkW | max XXXkW</span>
				</div>
				<div class="chargeSessionElement">
					<span class="chargeSessionValue big" id="duration">0:00h</span>
					<span class="chargeSessionValue small" id="time">XX:XX - XX:XX</span>
					<span class="chargeSessionValue small" id="date">XX.XX.XX</span>
				</div>
			</li>
		</template>
	</ul>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
	<script src="js/DoughnutValue.js"></script>
	<script src="js/AnimatedValue.js"></script>
	<script>
		let dateLocaleSetting = "de-DE";
		function createChargeSession(data){
			let cS = document.querySelector("#chargeSession").content.firstElementChild.cloneNode(true);
			let chargeSessions = document.querySelector("#chargeSessions");
		
			cS.querySelector("#duration").textContent = Math.floor(data.duration / 3600)+":"+String(Math.round(data.duration % 3600 / 60)).padStart(2, '0')+"h";
			const timeOpts = {
				hour: '2-digit',
				minute: '2-digit'
			};
			cS.querySelector("#time").textContent = 
				(new Date(data.startTime)).toLocaleString(dateLocaleSetting, timeOpts)+" - "+
				(new Date(data.endTime)).toLocaleString(dateLocaleSetting, timeOpts)
			;
			cS.querySelector("#date").textContent = (new Date(data.startTime)).toLocaleString(dateLocaleSetting, {
				day: '2-digit',
				month: '2-digit',
				year: '2-digit'
			});
			cS.querySelector("#avgchargepower").textContent = data.avgChargePower+"kW";
			cS.querySelector("#minMaxChargePower").textContent = data.minChargePower+"kW" + " | " + data.maxChargePower+"kW";
			cS.querySelector("#kWh").textContent = Math.round(data.chargeEnergy/360, 2)/10+"kWh";
			cS.querySelector("#range").textContent = (data.rangeEnd - data.rangeStart)+"km";
			
			chargeSessions.appendChild(cS);
			
			new SOCchargeDoughnutValue(cS.querySelector("#chargesoc"), data.socStart, data.socEnd, "soc");
		}
		
		async function getJSON(link){
			return (await fetch(link)).json();
		}
		
		let beginTime = new Date();
		beginTime.setDate(beginTime.getDate()-300);
		beginTime.setHours(0,0,0,0);
		let endTime = null;
		
		async function updateChargingSessions(){
			console.log(beginTime);
			const chargingSessions = await getJSON(
				"../chargingSessions.php?beginTime="+Math.round(beginTime.getTime()/1000)+
				(endTime == null ? "" : "&endTime="+Math.round(endTime.getTime()/1000))
			);
			if(chargingSessions == undefined){
				alert("failed to decode carGraphData JSON");
				return;
			}
			processChargingSession(chargingSessions);
		}

		setInterval(updateChargingSessions, 60000);

		function processChargingSession(chargingSessions){
			for(const cid in chargingSessions){
				createChargeSession(chargingSessions[cid]);
			}
		}
		
		updateChargingSessions();
	</script>
</body>