<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" type="text/css" href="css/theme.css">
	<link rel="stylesheet" type="text/css" href="css/chargingOverview.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
	<title>chargingOverview</title>
</head>
<body>
	<ul class="chargeSessions" id="chargeSessions">
		<li class="chargeSession" id="chargeSessionHeader">
			<div class="chargeSessionElement doughnut">
				<span class="value small">SOC</span>
			</div>
			<div class="chargeSessionElement">
				<span class="value small">charged kWh</span>
			</div>
			<div class="chargeSessionElement">
				<span class="value small">gained range</span>
			</div>
			<div class="chargeSessionElement">
				<span class="value small">power (⌀, min, max)</span>
			</div>
			<div class="chargeSessionElement">
				<span class="value small">duration and date</span>
			</div>
		</li>
		<template id="chargeSession">
			<li class="chargeSession">
				<div class="chargeSessionElement doughnut">
					<canvas id="chargesoc"></canvas>
				</div>
				<div class="chargeSessionElements">
					<div class="chargeSessionElement">
						<label>charged kWh</label>
						<span>
							<span class="value big" id="kWh">00.00</span>
							<span class="unit">kWh</span>
						</span>
					</div>
					<div class="chargeSessionElement">
						<label>gained range</label>
						<span>
							<span class="value big" id="range">000</span>
							<span class="unit">km</span>
						</span>
					</div>
					<div class="chargeSessionElement">
						<label>power(⌀, min, max)</label>
						<span>
							<span class="value big" id="avgchargepower">XXX</span>
							<span class="unit">kW</span>
						</span>
						<span>
							<span class="value" id="minChargePower">XXX</span>
							<span class="unit small">kW</span>
							<span class="value">|</span>
							<span class="value" id="maxChargePower">XXX</span>
							<span class="unit small">kW</span>
						</span>
					</div>
					<div class="chargeSessionElement">
						<label>duration and date</label>
						<span>
							<span class="value big" id="duration">XXX</span>
							<span class="unit">h</span>
						</span>
						<div class="chargeSessionTimeDate">
							<span class="value small" id="time">XX:XX - XX:XX</span>
							<span class="value small" id="date">XX.XX.XX</span>
						</div>
					</div>
				</div>
			</li>
		</template>
	</ul>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
	<script src="js/DoughnutValue.js"></script>
	<script src="js/AnimatedValue.js"></script>
	<script>
		//document.documentElement.setAttribute('data-theme', 'dimmed');
		document.documentElement.setAttribute('data-chargeSessions-mobile-label', 'display');
		let dateLocaleSetting = "de-DE";
		function createChargeSession(data){
			let cS = document.querySelector("#chargeSession").content.firstElementChild.cloneNode(true);
			let chargeSessions = document.querySelector("#chargeSessions");
		
			cS.querySelector("#duration").textContent = Math.floor(data.duration / 3600)+":"+String(Math.round(data.duration % 3600 / 60)).padStart(2, '0');
			const timeOpts = {
				hour: '2-digit',
				minute: '2-digit'
			};
			cS.querySelector("#time").textContent = 
				(new Date(data.startTime)).toLocaleString(dateLocaleSetting, timeOpts)+" - "+
				(new Date(data.endTime)).toLocaleString(dateLocaleSetting, timeOpts)
			;
			cS.querySelector("#date").textContent = (new Date(data.startTime)).toLocaleString(dateLocaleSetting, {
				day: '2-digit',
				month: '2-digit',
				year: '2-digit'
			});
			cS.querySelector("#avgchargepower").textContent = data.avgChargePower;
			cS.querySelector("#minChargePower").textContent = data.minChargePower
			cS.querySelector("#maxChargePower").textContent = data.maxChargePower;
			cS.querySelector("#kWh").textContent = Math.round(data.chargeEnergy/360, 2)/10;
			cS.querySelector("#range").textContent = (data.rangeEnd - data.rangeStart);
			
			chargeSessions.appendChild(cS);
			
			new SOCchargeDoughnutValue(cS.querySelector("#chargesoc"), data.socStart, data.socEnd, "soc");
		}
		
		async function getJSON(link){
			return (await fetch(link)).json();
		}
		
		let beginTime = new Date();
		beginTime.setDate(beginTime.getDate()-300);
		beginTime.setHours(0,0,0,0);
		let endTime = null;
		
		async function updateChargingSessions(){
			console.log(beginTime);
			const chargingSessions = await getJSON(
				"../chargingSessions.php?beginTime="+Math.round(beginTime.getTime()/1000)+
				(endTime == null ? "" : "&endTime="+Math.round(endTime.getTime()/1000))
			);
			if(chargingSessions == undefined){
				alert("failed to decode carGraphData JSON");
				return;
			}
			processChargingSession(chargingSessions);
		}

		setInterval(updateChargingSessions, 60000);

		function processChargingSession(chargingSessions){
			for(const cid in chargingSessions){
				createChargeSession(chargingSessions[cid]);
			}
		}
		
		updateChargingSessions();
	</script>
</body>